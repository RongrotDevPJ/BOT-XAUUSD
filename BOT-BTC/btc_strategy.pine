// This Pine Script‚Ñ¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© TradingView

//@version=5
strategy("BTC Mean Reversion + Trend Filter (2026 Edition)", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ==========================================
// ‚öôÔ∏è INPUTS
// ==========================================
rsi_length = input.int(14, "RSI Length")
rsi_oversold = input.int(30, "RSI Oversold Level")
rsi_overbought = input.int(70, "RSI Overbought Level")

ema_trend_length = input.int(200, "EMA Trend Filter (Long Term)")
ema_exit_length = input.int(20, "EMA Exit (Short Term)")

stop_loss_pct = input.float(2.0, "Stop Loss (%)") / 100
trailing_stop_pct = input.float(3.0, "Trailing Stop (%)") / 100

// ==========================================
// üìà INDICATORS
// ==========================================
rsi_val = ta.rsi(close, rsi_length)
ema_trend = ta.ema(close, ema_trend_length)
ema_exit = ta.ema(close, ema_exit_length)

plot(ema_trend, color=color.blue, title="EMA Trend (200)")
plot(ema_exit, color=color.orange, title="EMA Exit (20)")

// ==========================================
// üöÄ STRATEGY LOGIC
// ==========================================
// Core Logic: Buy when RSI is Oversold AND Price is above EMA 200 (Trend is Up)
long_condition = rsi_val < rsi_oversold and close > ema_trend

if (long_condition)
    strategy.entry("Long", strategy.long, comment="Buy Signal (RSI < 30 + Price > EMA 200)")

// Exit Strategy: Close when RSI is Overbought OR Price touches EMA 20
exit_condition = rsi_val > rsi_overbought or close < ema_exit

if (exit_condition)
    strategy.close("Long", comment="Exit Signal (RSI > 70 or Price < EMA 20)")

// ==========================================
// üõ°Ô∏è RISK MANAGEMENT
// ==========================================
// Fixed Stop Loss
float sl_price = na
if (strategy.position_size > 0)
    sl_price := strategy.position_avg_price * (1 - stop_loss_pct)
    strategy.exit("SL", "Long", stop=sl_price, comment="Stop Loss Hit")

// Trailing Stop Logic
float highest_price = ta.highest(high, strategy.position_size > 0 ? bar_index - strategy.opentrades.entry_bar_index(0) + 1 : 1)
float trail_price = highest_price * (1 - trailing_stop_pct)

if (strategy.position_size > 0)
    strategy.exit("Trailing Stop", "Long", stop=trail_price, comment="Trailing Stop Hit")

// ==========================================
// üìä VISUALIZATION
// ==========================================
plotshape(long_condition, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="Buy Signal")
plotshape(exit_condition and strategy.position_size > 0, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="Exit Signal")
